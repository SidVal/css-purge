name: Reiniciar Sandbox

on:
  workflow_dispatch:

permissions:
  contents: write

concurrency:
  group: reset-sandbox
  cancel-in-progress: false

jobs:
  reset:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: true

      - name: Resetear src y public
        shell: bash
        run: |
          set -euo pipefail

          rm -rf src public
          mkdir -p src public

      - name: Crear base mínima funcional
        shell: bash
        run: |
          set -euo pipefail

          cat > src/index.html <<'EOF'
          <!doctype html>
          <html lang="es">
            <head>
              <meta charset="utf-8" />
              <meta name="viewport" content="width=device-width, initial-scale=1" />
              <meta name="robots" content="noindex,nofollow" />
              <title>css-purge sandbox reset</title>
              <link rel="stylesheet" href="./styles.purged.css" />
            </head>
            <body class="page">
              <main class="container">
                <h1 class="title">Sandbox reiniciado</h1>
                <p class="lead">
                  El entorno fue reinicializado correctamente.
                </p>
                <button class="btn btn-primary">Botón</button>
              </main>
            </body>
          </html>
          EOF

          cat > src/styles.css <<'EOF'
          .page { font-family: system-ui, sans-serif; padding: 24px; }
          .container { max-width: 720px; margin: 0 auto; }
          .title { font-size: 28px; margin-bottom: 12px; }
          .lead { margin-bottom: 16px; }
          .btn { padding: 10px 14px; border: 1px solid #222; background: white; border-radius: 8px; }
          .btn-primary { background: black; color: white; }

          /* Clases no usadas para testear purge */
          .legacy-x { color: red; }
          .legacy-y { color: blue; }
          .legacy-z { color: green; }
          EOF

          cat > public/robots.txt <<'EOF'
          User-agent: *
          Disallow: /
          EOF

          : > public/.gitkeep

      - name: Commit y push
        shell: bash
        run: |
          set -euo pipefail

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add src public

          if git diff --cached --quiet; then
            echo "No hay cambios."
            exit 0
          fi

          git commit -m "chore: reiniciar sandbox"
          git push
